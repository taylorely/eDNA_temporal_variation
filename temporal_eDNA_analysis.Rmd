---
title: "Investigating temporal and spatial variation of eDNA in a nearshore rocky reef environment Data Analysis"
author: "Taylor Ely and Zack Gold"
date: "12/18/2020"
output:
  html_document
---

#Load Packages
```{r}
library(ranacapa)
library(phyloseq)
library(tidyverse)
library(dplyr)
library(tibble)
library(reshape2)
library(ggplot2)
library(treemapify)
library(vegan)
library(plotly)
library(optparse)
library(ggrepel)
library(wesanderson) 
library(cluster)
library(biomformat)
library('gridBase')
library(devtools)
library(grid)
library(gridExtra)
library(ape)
library(scales)
library(tidyr)
library(RColorBrewer)
library(treemap)
library(iNEXT)
library(stats)
library(plyr)
library(dplyr)
library(here)
```
#Load All Data Sets
```{r}

here()

#Dock eDNA Index (2017 data)
t_index <- readRDS(here("decontam","Output_R","taylor_pre_occupancy_results_sum.taxonomy_bio_reps_separate_eDNA_index.RDS"))
t_reads <- readRDS(here("decontam","Output_R","taylor_pre_occupancy_results_sum.taxonomy_bio_reps_separate_read_counts.RDS"))
#Cove & Channel Species eDNA Index (2016 data)
z_index <- readRDS(here("decontam","Output_R","cat16_pre_occupancy_results_sum.taxonomy_bio_reps_separate_eDNA_index.RDS"))
View(z_index)
z_reads <- readRDS(here("decontam","Output_R","cat16_pre_occupancy_results_sum.taxonomy_bio_reps_separate_read_counts.RDS"))
#remove positive
z_index<-select(z_index, -Cat.poscntl_1) 

#Metadata for all
metadata <- read.table("MetaData_eDNA_degradation2020.txt", header = 1, sep = "\t", stringsAsFactors = F)
metadata$Transect <- factor(metadata$Transect, levels = c("Dock", "Cove", "Channel"))
#metadata for just dock samples
metadataDK<-metadata[6:41,]
#metadata for just cove and channel samples
metadataBFFC<-metadata[42:99,]

monitored_species <- read.table("Monitored_Species_list_20201204.txt", header = 1, sep = "\t", stringsAsFactors = F)


monitored_species$Scientific.name -> monitored_species_list

monitored_species %>% 
  filter(., RCCA=="X") %>% dplyr::select(Scientific.name) -> rcca_species_list

rcca_species_list$Scientific.name -> rcca_species_list
```
```{r}
# Load color palettes
col3.gr <- wes_palette(name = "Darjeeling1", n=5, type="discrete")
col2.gr <- wes_palette(name = "Darjeeling2", n=5, type="discrete")
col1.gr <- wes_palette(name = "GrandBudapest1", n=4, type="discrete")
col4.gr <- wes_palette(name = "Royal1", n=4, type="discrete")
col5.gr <- wes_palette(name = "GrandBudapest2", n=4, type="discrete")
col6.gr <- wes_palette(name = "Chevalier1", n=4, type="discrete")
col7.gr <- wes_palette(name = "Moonrise3", n=4, type="discrete")
col8.gr <- wes_palette(name = "Cavalcanti1", n=5, type="discrete")
col9.gr <- wes_palette(name = "Chevalier1", n=4, type="discrete")
col.great <- c(col1.gr[3],col3.gr[1],col1.gr[2],col3.gr[4],col6.gr[2],col6.gr[1],col2.gr[4],col2.gr[2],col5.gr[2],col4.gr[1],col4.gr[3],col7.gr[2],col7.gr[3],col4.gr[3])
col.great2 <- c(col3.gr[5],col2.gr[2],col7.gr[1],col2.gr[4],col8.gr[4],col3.gr[2],col4.gr[1], col6.gr[3], col9.gr[3])
col10= palette(brewer.pal(n=10,name="PuBuGn"))
colfunc<-colorRampPalette(c(col2.gr[2],col3.gr[5],"springgreen",col9.gr[1]))
col.great3 <- c(col3.gr[5],col2.gr[2],col7.gr[1],col2.gr[4])

#Generate Colors
wes_palette("Darjeeling1") -> col_darjeeling1
wes_palette("IsleofDogs1") -> col_dogs1
wes_palette("Cavalcanti1") -> col_Cavalcanti1
wes_palette("BottleRocket2") -> col_BottleRocket2
wes_palette("BottleRocket1") -> col_BottleRocket1
wes_palette("Royal1") -> col_Royal1
wes_palette("Royal2") -> col_Royal2
wes_palette("Zissou1") -> col_Zissou1
wes_palette("Darjeeling2") -> col_Darjeeling2
wes_palette("Rushmore1") -> col_Rushmore1
col_species<-c(col_darjeeling1[2],col_Cavalcanti1[2], col_Darjeeling2[2])
col_plot4<-c(col_Rushmore1[3],col_Darjeeling2[3],col_darjeeling1[5],col_dogs1[4])
col_nmds<-c(col_Zissou1[1],col_Cavalcanti1[2],col_Darjeeling2[3])
```
#Figure 1 is a map of transects and was created in powerpoint

#Figure 2. Detection of Foreign eDNA over Time
```{r}
#Select Grass Carp Species Only
t_index %>% as.data.frame() %>% 
  filter(., sum.taxonomy =="Eukaryota;Chordata;Actinopteri;Cypriniformes;Cyprinidae;Ctenopharyngodon;Ctenopharyngodon idella")-> gcarp_idx

# Convert to Long Data
columns <- colnames(t_index)
remove <- c("sum.taxonomy")
gathercols <-  columns[! columns %in% remove] 

gcarp_idx_clean <- gather(gcarp_idx, e_index, gathercols, factor_key=TRUE)

#Remove Name
gcarp_idx_clean[1:36,] -> gcarp_idx_clean

#Format Data
gcarp_idx_clean %>% 
  dplyr::rename(., Names =e_index, e_index=gathercols) -> gcarp_idx_clean

gcarp_idx_clean$e_index <- as.numeric(gcarp_idx_clean$e_index)

gcarp_idx_clean %>% 
  left_join(metadataDK) ->eDNA_data

total<-aggregate(eDNA_data$e_index, by=list(eDNA_data$Time_Point), FUN="mean")
total<- total %>% 
  dplyr::rename(
    Names = Group.1,
    e_index = x
    )
total$Time_Point<-total$Names
total$Replicate<-"Mean"
total$Time<-c(0.0, 1.5, 3.0, 4.5, 6.0, 7.5, 9.0, 10.5, 12.0, 24.0, 48.0, 96.0)
total<-rbind.fill(eDNA_data, total)
View(total)

#Plot Grass Carp eDNA Index vs. Time after Foreign eDNA Introduction 
fig2 <- total %>% 
  filter(., Time > 1) %>% 
  filter(., Time < 25) %>% 
  ggplot(., aes(x=Time, y=e_index, shape=Replicate, color=Replicate), group=Replicate) + 
  geom_point(size=4) +
  theme_ranacapa()  +
  scale_shape_manual(values=c(0, 1, 2, 5)) + 
  scale_color_manual(values=col_plot4)+
  ylab("Foreign eDNA Index Score") +
  labs(shape="Replicate") +  
            scale_x_continuous(breaks=c(3, 6, 9, 12, 24)) + xlab( "Time (hrs)") +
    theme(axis.title.x = element_text(size=17,face= "bold", colour= "black"),
          axis.title.y = element_text(size=17,face= "bold", colour= "black"),
          legend.title = element_text(size=16,face= "bold", colour= "black"),
          axis.text= element_text(size=14,face= "plain", colour= "black"),
          legend.text = element_text(size=14,face= "plain", colour= "black")) 

# save figure in the right format and size for publishing
ggsave(filename ="Fig2.tiff",
       plot = fig2,
       dpi = 300,
       width = 6.5,
  height = 4,
  units = c("in"))
```

#Ranacapa Code
```{r anacapa to phyloseq functions from ranacapa library imported manually since they do not work on R3.6.0,  results="hide", warning=FALSE, include=FALSE}
#' Takes a site-abundance table from Anacapa, and summarizes to each unique taxon in the sum.taxonomy column
#' @param taxon_table OTU table from Anacapa
#' @author Gaurav Kandlikar
#' @examples
#' good_taxon_table <- data.frame(sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' group_anacapa_by_taxonomy(good_taxon_table)
#' @export
group_anacapa_by_taxonomy <- function(taxon_table) {
  # If tables were made in New Anacapa (with Domain), get rid of domain...
  if(stringr::str_count(taxon_table$sum.taxonomy, ";")[1] == 7) {
    taxon_table$sum.taxonomy = gsub(pattern = "^.*?;", replacement = "", x = taxon_table$sum.taxonomy)
  }
  taxon_table %>%
    dplyr::filter(sum.taxonomy != "") %>%
    dplyr::group_by(sum.taxonomy) %>%
    dplyr::summarize_if(is.numeric, sum) %>%
    dplyr::mutate(sum.taxonomy = as.character(sum.taxonomy)) %>%
    data.frame
}


#' Takes an site-abundance table from Anacapa, along with a qiime-style mapping file, and returns a phyloseq object
#' @param taxon_table Taxon table in the anacapa format
#' @param metadata_file Metadata file with rows as sites, columns as variables
#' @return phyloseq class object
#' @author Gaurav Kandlikar
#' @examples
#' good_taxon_table <- data.frame(sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' good_maps <- data.frame(site = c("site_1", "site_2"), season = c("wet", "dry"),
#'  host = c("oak", "sage"))
#' convert_anacapa_to_phyloseq(good_taxon_table, good_maps)
#' @export

convert_anacapa_to_phyloseq <- function(taxon_table, metadata_file) {

  # Validate the files
  validate_input_files(taxon_table, metadata_file)

  # Group the anacapa ouptut by taxonomy, if it has not yet happened, and turn it into a matrix
  taxon_table2 <- group_anacapa_by_taxonomy(taxon_table) %>%
    tibble::column_to_rownames("sum.taxonomy") %>%
    as.matrix
  # Reorder the columns (sites) for ease of displaying later
  taxon_table2 <- taxon_table2[ , order(colnames(taxon_table2))]

  # Convert the matrix into a phyloseq otu_table object, with taxa as the rows
  ana_taxon_table_physeq <- phyloseq::otu_table(taxon_table2, taxa_are_rows = TRUE)

  # Extract the rownames of the matrix above- this has the full taxonomic path.
  # Split the taxonomic path on semicolons, and turn the resulting matrix into
  # a phyloseq tax_table object
  taxon_names <- reshape2::colsplit(rownames(taxon_table2), ";",
                          names = c("Domain","Phylum","Class","Order","Family","Genus","Species")) %>%
    as.matrix
  rownames(taxon_names) <- rownames(taxon_table2)

  tax_physeq <- phyloseq::tax_table(taxon_names)
  colnames(tax_physeq) <- c("Domain","Phylum","Class","Order","Family","Genus","Species")

  # Make a phyloseq object out of the otu_table and the tax_table objects
  physeq_object <- phyloseq::phyloseq(ana_taxon_table_physeq, tax_physeq)

  # Make sure the mapping file (ie the site metadata) is ordered according to site name
  rownames(metadata_file) <- metadata_file[, 1]
  metadata_file <- metadata_file[order(metadata_file[, 1]), ]

  # Convert the mapping file into a phyloseq sample_data object, and merge it with the
  # phyloseq object created above to make a phyloseq object with otu table, tax table, and sample data.
  sampledata <- phyloseq::sample_data(metadata_file)
  phyloseq::merge_phyloseq(physeq_object, sampledata)
}

#' Takes a phyloseq object with an otu_table object and returns a vegan style community matrix.
#' @param physeq_object phyloseq object with an otu_table object within
#' @return vegan-style community matrix
#' @examples
#' good_taxon_table <- data.frame(sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' good_maps <- data.frame(site = c("site_1", "site_2"), season = c("wet", "dry"),
#' host = c("oak", "sage"))
#' physeq_object <- convert_anacapa_to_phyloseq(good_taxon_table, good_maps)
#' vegan_otu(physeq_object)
#' @export
vegan_otu <- function(physeq_object) {
  OTU <- phyloseq::otu_table(physeq_object)
  if (phyloseq::taxa_are_rows(OTU)) {
    OTU <- t(OTU)
  }
  return(methods::as(OTU, "matrix"))
}

#' Remove "xxx_seq_number" column from ana_taxon_table file if it exists
#' takes one taxon table as its input, and if it include
#' a column named "xxx_seq_number", it gets rid of that column - it's not of use to us
#' any longer
#'
#' @param taxon_table taxonomy table from Anacapa
#' @return ana_taxon_table file, with "xxx_seq_number" column removed (if it existed)
#' @examples
#' good_taxon_table <- data.frame(seq_number = c(1,2),
#' sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' scrub_seqNum_column(good_taxon_table)
#' @export
scrub_seqNum_column <- function(taxon_table) {
  to_return <- taxon_table %>% dplyr::select(-dplyr::matches("seq_number"))
  return(to_return)
}

#' Replace empty calls in Anacapa taxonomy tables with Unknown
#' (that is what they effectively are to most users)
#' @param taxon_table taxonomy table from Anacapa
#' @return ana_taxon_table with scrubbed 'sum.taxonomy' column
#' @examples
#' good_taxon_table <- data.frame(sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' scrub_taxon_paths(good_taxon_table)
#' @export
scrub_taxon_paths <- function(taxon_table) {
  to_return <- taxon_table
  new_sum_tax <- reshape2::colsplit(taxon_table$sum.taxonomy, ";",
                          names = c("Domain","Phylum", "Class", "Order", "Family", "Genus", "Species"))

  new_sum_tax <- new_sum_tax %>%
    dplyr::mutate(Domain = ifelse(is.na(Domain) | Domain == "", "unknown", Domain)) %>%
    dplyr::mutate(Phylum = ifelse(is.na(Phylum) | Phylum == "", "unknown", Phylum)) %>%
    dplyr::mutate(Class = ifelse(is.na(Class) | Class == "", "unknown", Class)) %>%
    dplyr::mutate(Order = ifelse(is.na(Order) | Order == "", "unknown", Order)) %>%
    dplyr::mutate(Family = ifelse(is.na(Family) | Family == "", "unknown", Family)) %>%
    dplyr::mutate(Genus = ifelse(is.na(Genus) | Genus == "", "unknown", Genus)) %>%
    dplyr::mutate(Species = ifelse(is.na(Species)| Species == "", "unknown", Species))

  new_sum_tax2 <- paste(new_sum_tax$Domain,
                        new_sum_tax$Phylum,
                        new_sum_tax$Class,
                        new_sum_tax$Order,
                        new_sum_tax$Family,
                        new_sum_tax$Genus,
                        new_sum_tax$Species, sep = ";")
  to_return$sum.taxonomy <- new_sum_tax2
  return(to_return)
}

#' Verify that the input taxon_table file and the input mapping file meets specificationss
#' The function takes one taxon table as its input, and verfies that it meets
#' the expected standards.
#' The standards incude:
#' 1. Column names exist.
#' 2. One of the columns is named "sum.taxonomy"
#' 3. The "xxx_seq_number" column, if it ever existed, is removed
#' 4. All columns apart from sum.taxonomy should be numeric
#' 5. All columns apart from sum.taxonomy should have corresponding row in metadata file
#' @param taxon_table taxonomy table from Anacapa
#' @param metadata_file Qiime-style mapping
#' @examples
#' good_taxon_table <- data.frame(sum.taxonomy = c("a;b;c;d;f;u", "p;q;r;s;t;u"),
#' site_1 = c(0,1), site_2 = c(10, 20))
#' good_maps <- data.frame(site = c("site_1", "site_2"),
#' season = c("wet", "dry"), host = c("oak", "sage"))
#' validate_input_files(good_taxon_table, good_maps)
#' @export
validate_input_files <- function(taxon_table, metadata_file) {

  # 1. Column names exist.
  if (is.null(colnames(taxon_table))) {
    stop("The input taxon table should have column names. The taxonomy column should be named 'sum.taxonomy'; the rest of the columns should be named according to their sample names.")
  }

  # 2. One of the columns is named "sum.taxonomy"
  if (!("sum.taxonomy" %in% colnames(taxon_table))) {
    stop("Please make sure that the taxonomy column in the input taxon table is named 'sum.taxonomy'!")
  }

  # 3. The "xxx_seq_number" column, if it ever existed, is removed
  if (any(stringr::str_detect(colnames(taxon_table), "seq_number"))) {
    stop("Please makes sure that you have removed the 'xxx_seq_number' column from the taxon table (note: this can be done with the function `scrub_seqNum_column`)")
  }

  # 4. All columns apart from sum.taxonomy should be numeric
  if (!(all(sapply(taxon_table %>% dplyr::select(-sum.taxonomy), is.numeric)))) {
    stop("Please make sure that all columns apart from sum.taxonomy only contain numeric data!")
  }

  # 5. All columns apart from sum.taxonomy should have corresponding row in metadata file
  if (!(all(colnames(taxon_table %>% dplyr::select(-sum.taxonomy)) %in% metadata_file[, 1]))) {
    stop("Please make sure that each sample in your taxon table has a corresponding row in the mapping file!")
  }


}

```



### Create Phyloseq Objects
```{r}
#Create phyloseq objects
#Dock Species
physeq_obj.t <- convert_anacapa_to_phyloseq(t_index, metadataDK)
#Cove & Channel Species 
physeq_obj.z <- convert_anacapa_to_phyloseq(z_index, metadataBFFC)
#together
physeq_obj.ind<-merge_phyloseq(physeq_obj.t,physeq_obj.z)
```

```{r}
#removed Lab or Field Contaminant ASVs as this DNA could be found in water through runoff or recreation activities. Also remove the grass carp DNA as that is not part of the natural community signal
badTaxa = c("","Unassigned",
            "NA",
            "Eukaryota;Chordata;;NA;;;",
             "Eukaryota;Chordata;Actinopteri;;;;",
            "Eukaryota;Chordata;Actinopteri;Salmoniformes;Salmonidae;Salmo;Salmo salar","Eukaryota;Chordata;Actinopteri;Salmoniformes;Salmonidae;Oncorhynchus;","Eukaryota;Chordata;Actinopteri;Salmoniformes;Salmonidae;Oncorhynchus;Oncorhynchus tshawytscha",
            "Eukaryota;Chordata;Mammalia;Primates;Hominidae;Homo;Homo sapiens",
            "Eukaryota;Chordata;Mammalia;Artiodactyla;Bovidae;Bos;Bos taurus",
            "Eukaryota;Chordata;Actinopteri;Salmoniformes;Salmonidae;Salmo;",
            "Eukaryota;Chordata;Actinopteri;Cypriniformes;Cyprinidae;Ctenopharyngodon;Ctenopharyngodon idella",
            "Eukaryota;Chordata;Aves;Galliformes;Phasianidae;Gallus;Gallus gallus",
             "Eukaryota;Chordata;Mammalia;Artiodactyla;Suidae;Sus;Sus scrofa",
            "Eukaryota;Chordata;Mammalia;Rodentia;Cricetidae;Peromyscus;Peromyscus maniculatus",
            "Eukaryota;Chordata;;;;;",
            "Eukaryota;Chordata;Mammalia;Carnivora;Canidae;Canis;Canis lupus",
            "Eukaryota;Chordata;Mammalia;Carnivora;Felidae;Felis;Felis catus",
            "Eukaryota;Chordata;Mammalia;Primates;Hominidae;Pan;",
            "Eukaryota;Chordata;Mammalia;Primates;Hominidae;Pan;Pan paniscus",
            "Eukaryota;Chordata;Myxini;Myxiniformes;Myxinidae;Myxine;Myxine circifrons")

goodTaxa_1 <- setdiff(taxa_names(physeq_obj.ind), badTaxa)
physeq_obj.ind <- prune_taxa(goodTaxa_1, physeq_obj.ind)
goodTaxa_2 <- setdiff(taxa_names(physeq_obj.t), badTaxa)
physeq_obj.DK <- prune_taxa(goodTaxa_2, physeq_obj.t)
goodTaxa_3 <- setdiff(taxa_names(physeq_obj.z), badTaxa)
physeq_obj.z <- prune_taxa(goodTaxa_3, physeq_obj.z)
```

```{r}
#Species Monitored by NPS, PISCO, and Reef Check
taxa_names(physeq_obj.ind) %>% 
  as_tibble() %>% 
  separate(., value, into = c("Domain","Phylum","Class","Order","Family","Genus","Species"), sep=";", remove=FALSE) %>% 
  filter(., Species %in% monitored_species_list) -> monitored_species_path
taxa_names(physeq_obj.DK) %>% 
  as_tibble() %>% 
  separate(., value, into = c("Domain","Phylum","Class","Order","Family","Genus","Species"), sep=";", remove=FALSE) %>% 
  filter(., Species %in% monitored_species_list) -> monitored_species_path2

physeq_obj.monitored <- prune_taxa(monitored_species_path$value, physeq_obj.ind)
physeq_obj.DKm <- prune_taxa(monitored_species_path2$value, physeq_obj.DK)
```

```{r}
# Only cove transect
physeq_obj.BF<-subset_samples(physeq_obj.z, Transect == "Cove")
physeq_obj.BF<-filter_taxa(physeq_obj.BF, function(x) sum(x) >0, TRUE)
# Only channel transect
physeq_obj.FC<-subset_samples(physeq_obj.z, Transect == "Channel")
physeq_obj.FC<-filter_taxa(physeq_obj.FC, function(x) sum(x) >0, TRUE)
# Only cove transect for monitored
physeq_obj.BFm<-subset_samples(physeq_obj.monitored, Transect == "Cove")
physeq_obj.BFm<-filter_taxa(physeq_obj.BFm, function(x) sum(x) >0, TRUE)
# Only channel transect for monitored
physeq_obj.FCm<-subset_samples(physeq_obj.monitored, Transect == "Channel")
physeq_obj.FCm<-filter_taxa(physeq_obj.FCm, function(x) sum(x) >0, TRUE)
```

# Get counts for reporting in paper
```{r}
# Get counts of richness within different taxonomic levels
get_taxa_unique(physeq_obj.ind, "Class")
get_taxa_unique(physeq_obj.ind, "Order")
get_taxa_unique(physeq_obj.ind, "Family")
get_taxa_unique(physeq_obj.ind, "Genus")
get_taxa_unique(physeq_obj.ind, "Species")
get_taxa_unique(physeq_obj.monitored, "Species")
# Get counts of richness within different taxonomic levels at dock transect
get_taxa_unique(physeq_obj.DK, "Class")
get_taxa_unique(physeq_obj.DK, "Order")
get_taxa_unique(physeq_obj.DK, "Family")
get_taxa_unique(physeq_obj.DK, "Genus")
get_taxa_unique(physeq_obj.DK, "Species")
get_taxa_unique(physeq_obj.DKm, "Species")
# Get counts of richness within different taxonomic levels at cove transect
get_taxa_unique(physeq_obj.BF, "Class")
get_taxa_unique(physeq_obj.BF, "Order")
get_taxa_unique(physeq_obj.BF, "Family")
get_taxa_unique(physeq_obj.BF, "Genus")
get_taxa_unique(physeq_obj.BF, "Species")
get_taxa_unique(physeq_obj.BFm, "Species")

# Get counts of richness within different taxonomic levels at channel transect
get_taxa_unique(physeq_obj.FC, "Class")
get_taxa_unique(physeq_obj.FC, "Order")
get_taxa_unique(physeq_obj.FC, "Family")
get_taxa_unique(physeq_obj.FC, "Genus")
get_taxa_unique(physeq_obj.FC, "Species")
get_taxa_unique(physeq_obj.FCm, "Species")

```


#Fig S1A. Ordered detection plot for sum of all transects
```{r}
#reformat for figure
taxa_names(physeq_obj.ind) %>% as_tibble() %>% 
  separate(., col=value, into=c("Domain","Phylum","Class", "Order", "Family", "Genus", "Species"), sep="\\;",remove = FALSE) %>%
  mutate(., Species = ifelse(Species=="", Genus, Species)) %>% 
  mutate(., Species = ifelse(Species=="", Family, Species)) %>% 
  mutate(., Species = ifelse(Species=="", Order, Species)) %>% 
  mutate(., Species = ifelse(Species=="", Class, Species))-> final_namers

# order taxa by andundance for all taxa not just monitored for data use in paper
##extract otu_table and make it as a dataframe
abundance_orderind<-as(otu_table(physeq_obj.ind), "matrix")
OTUdfind = as.data.frame(abundance_orderind)
#create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdfind$rank<-apply(OTUdfind,1,function(x) sum(x > 0))
rank_speciesind<-row.names(OTUdfind)
OTUdfind$species<-rank_speciesind
# order
orderind<-OTUdfind[order(OTUdfind$rank),]

# make the correct order a vector
rank<-orderind$species
rank_orderind<-orderind$rank
abundance_plotind<-cbind(rank, rank_orderind)
abundance_plotind<-as.data.frame(abundance_plotind)
abundance_plotind<- abundance_plotind %>% separate(rank, c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
abundance_plotind$percentage<-(rank_orderind/94)*100


#order taxa by abundance over samples
##extract otu_table and make it as a dataframe
abundance_order<-as(otu_table(physeq_obj.monitored), "matrix")
OTUdf = as.data.frame(abundance_order)
#create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdf$rank<-apply(OTUdf,1,function(x) sum(x > 0))
rank_species<-row.names(OTUdf)
OTUdf$species<-rank_species
# order
order<-OTUdf[order(OTUdf$rank),]

# make the correct order a vector
rank<-order$species
rank_order<-order$rank
abundance_plot<-cbind(rank, rank_order)
abundance_plot<-as.data.frame(abundance_plot)
abundance_plot<- abundance_plot %>% separate(rank, c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
abundance_plot$percentage<-(rank_order/94)*100


# Make this supplementary figrure to visualize detection in samples
jpeg(here("figures","FigS1A.tiff"), width=7, height=4.5, units = "in", res=600)
percentage_plot <- ggplot(abundance_plot, aes(x = reorder(species, percentage), y = percentage))+
  geom_bar(stat="identity",  width=0.8,  fill="steelblue") + ylim(NA,100) + coord_flip() + theme_classic() + labs(y= "Detection Percentage in All Samples", x = "Monitored Species") 
percentage_plot
dev.off()
```

#Fig S1B. Ordered detection plot for Dock
```{r}
#order taxa by abundance over samples
##extract otu_table and make it as a dataframe
abundance_orderDK<-as(otu_table(physeq_obj.DKm), "matrix")
OTUdfDK = as.data.frame(abundance_orderDK)
#create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdfDK$rank<-apply(OTUdfDK,1,function(x) sum(x > 0))
rank_speciesDK<-row.names(OTUdfDK)
OTUdfDK$species<-rank_speciesDK
# order
orderDK<-OTUdfDK[order(OTUdfDK$rank),]

# make the correct order a vector
rankDK<-orderDK$species
rank_orderDK<-orderDK$rank
abundance_plotDK<-cbind(rankDK, rank_orderDK)
abundance_plotDK<-as.data.frame(abundance_plotDK)
abundance_plotDK<- abundance_plotDK %>% separate(rankDK, c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
abundance_plotDK$percentage<-(rank_orderDK/36)*100


# Make this supplementary figrure to visualize detection in samples
jpeg(here("figures","FigS1B.tiff"), width=7, height=4.5, units = "in", res=600)
percentage_plotDK <- ggplot(abundance_plotDK, aes(x = reorder(species, percentage), y = percentage))+
  geom_bar(stat="identity",  width=0.8,  fill="steelblue") + ylim(NA,100) + coord_flip() + theme_classic() + labs(y= "Detection Percentage in Dock Transect", x = "Monitored Species") 
percentage_plotDK
dev.off()
```

#Fig S1C. Ordered detection plot for Cove
```{r}
#order taxa by abundance over samples
##extract otu_table and make it as a dataframe
abundance_orderBF<-as(otu_table(physeq_obj.BFm), "matrix")
OTUdfBF = as.data.frame(abundance_orderBF)
#create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdfBF$rank<-apply(OTUdfBF,1,function(x) sum(x > 0))
rank_speciesBF<-row.names(OTUdfBF)
OTUdfBF$species<-rank_speciesBF
# order
orderBF<-OTUdfBF[order(OTUdfBF$rank),]

# make the correct order a vector
rankBF<-orderBF$species
rank_orderBF<-orderBF$rank
abundance_plotBF<-cbind(rankBF, rank_orderBF)
abundance_plotBF<-as.data.frame(abundance_plotBF)
abundance_plotBF<- abundance_plotBF %>% separate(rankBF, c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
abundance_plotBF$percentage<-(rank_orderBF/30)*100


# Make this supplementary figrure to visualize detection in samples
jpeg(here("figures","FigS1C.tiff"), width=7, height=4.5, units = "in", res=600)
percentage_plotBF <- ggplot(abundance_plotBF, aes(x = reorder(species, percentage), y = percentage))+
  geom_bar(stat="identity",  width=0.8,  fill="steelblue") + ylim(NA,100) + coord_flip() + theme_classic() + labs(y= "Detection Percentage in Cove Transect", x = "Monitored Species") 
percentage_plotBF
dev.off()
```

#Fig S1D. Ordered detection plot for Channel
```{r}
#order taxa by abundance over samples
##extract otu_table and make it as a dataframe
abundance_orderFC<-as(otu_table(physeq_obj.FCm), "matrix")
OTUdfFC = as.data.frame(abundance_orderFC)
#create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdfFC$rank<-apply(OTUdfFC,1,function(x) sum(x > 0))
rank_speciesFC<-row.names(OTUdfFC)
OTUdfFC$species<-rank_speciesFC
# order
orderFC<-OTUdfFC[order(OTUdfFC$rank),]

# make the correct order a vector
rankFC<-orderFC$species
rank_orderFC<-orderFC$rank
abundance_plotFC<-cbind(rankFC, rank_orderFC)
abundance_plotFC<-as.data.frame(abundance_plotFC)
abundance_plotFC<- abundance_plotFC %>% separate(rankFC, c("domain", "phylum", "class", "order", "family", "genus", "species"), ";")
abundance_plotFC$percentage<-(rank_orderFC/28)*100


# Make this supplementary figrure to visualize detection in samples
jpeg(here("figures","FigS1D.tiff"), width=7, height=4.5, units = "in", res=600)
percentage_plotFC <- ggplot(abundance_plotFC, aes(x = reorder(species, percentage), y = percentage))+
  geom_bar(stat="identity",  width=0.8,  fill="steelblue") + ylim(NA,100) + coord_flip() + theme_classic() + labs(y= "Detection Percentage in Channel Transect", x = "Monitored Species") 
percentage_plotFC
dev.off()
```

#Fig 3. Heat map of monitored species ordered by detection faceted by transect
```{r}
# make zeros NAs for the na.value to be white
physeq_for_heatmap<-physeq_obj.monitored
otu_table(physeq_for_heatmap)[otu_table(physeq_for_heatmap) == 0.0000000] <-NA

#make figure
jpeg(here("figures","Fig3.tiff"), width=7.5, height=4.75, units="in",res=600)
monitored_heatmap<- plot_heatmap(physeq_for_heatmap, sample.label="Time_Label", taxa.label="Species", taxa.order=rank, sample.order="Time_Point",low="#66CCFF", high="#000033", na.value="white")+ scale_fill_gradient(name = "eDNA index", low="#66CCFF", high="#000033", na.value="white", breaks=c(0.25, 0.5, 0.75, 1.0))+theme (axis.text.x = element_text(size=7), axis.text.y = element_text(size=6), axis.title.x = element_text(size=18),axis.title.y = element_text(size=18), legend.title = element_text(size=10), legend.text = element_text(size=9), legend.text.align = 0 ) + theme(legend.key.height = unit(0.16,"in"), legend.key.width = unit(0.13, "in"), legend.margin = margin(0,0,0,0))
monitored_heatmap$scales$scales[[1]]$name <- "Sample"
monitored_heatmap + facet_grid(~Transect, switch="x", scales = "free", space = "free")
dev.off()
    
```


### Figure S2: Heat Map of all taxa faceted by transect
```{r}
#I need to order taxa by abundance over samples
##extract otu_table and make it as a dataframe
abundance_order_all<-as(otu_table(physeq_obj.ind), "matrix")
OTUdf_all = as.data.frame(abundance_order_all)
## create column to be able to rank abundance over samples and add species so I can extract the correct order
OTUdf_all$rank_all<-apply(OTUdf_all,1,function(x) sum(x > 0))
rank_species_all<-row.names(OTUdf_all)
OTUdf_all$species<-rank_species_all
## order
order_all<-OTUdf_all[order(OTUdf_all$rank_all),]

# make zeros NAs for the na.value to be white
physeq_for_heatmap_all<-physeq_obj.ind
otu_table(physeq_for_heatmap_all)[otu_table(physeq_for_heatmap_all) == 0.0000] <-NA

rownames(final_namers) <- rownames(tax_table(physeq_for_heatmap_all))
tax_table(as.matrix(final_namers)) -> tax_table_update
tax_table(physeq_for_heatmap_all) <- tax_table_update


#make the figure
jpeg(here("figures","FigS2.tiff"), width=7.5, height=6.25, units="in", res=600)
heat_all <- plot_heatmap(physeq_for_heatmap_all, sample.label="Time_Point", taxa.label="Species", taxa.order=rank_all, sample.order="Time_Point",low="#66CCFF", high="#000033", na.value="white") + scale_fill_gradient(name = "eDNA index", low="#66CCFF", high="#000033", na.value="white", breaks=c(0.25,0.5,0.75,1.0)) + theme (axis.text.x = element_text(size=5), axis.title.x = element_text(size=20),axis.title.y = element_text(size=20), legend.title = element_text(size=20), legend.text = element_text(size=16), legend.text.align = 0 ) 
heat_all$scales$scales[[1]]$name <- "Sample"
heat_all + facet_grid(~Transect, switch="x", scales = "free", space = "free")
dev.off()

```
# Figure 3. PERMANOVA apportioned variance plot
```{r}
#Generate Vegan formatted data table for Dock transect
sampledf_2DK <- data.frame(sample_data(physeq_obj.DK))
carnivore_rel_abun_2DK<- vegan_otu(physeq_obj.DK)
d_DK <- vegdist(carnivore_rel_abun_2DK, method="bray")
b_DK_tide<-betadisper(d_DK, sampledf_2DK$Direction)
anDK_tide<-anova(b_DK_tide)
anDK_tide
b_DK_time<-betadisper(d_DK, sampledf_2DK$Time_Point)
anDK_time<-anova(b_DK_time)
anDK_time

#Generate Vegan formatted data table for cove transect
sampledf_2BF <- data.frame(sample_data(physeq_obj.BF))
carnivore_rel_abun_2BF<- vegan_otu(physeq_obj.BF)
d_BF <- vegdist(carnivore_rel_abun_2BF, method="bray")
b_BF_tide<-betadisper(d_BF, sampledf_2BF$Direction)
anBF_tide<-anova(b_BF_tide)
anBF_tide
b_BF_time<-betadisper(d_BF, sampledf_2BF$Time_Point)
anBF_time<-anova(b_BF_time)
anBF_time


#Generate Vegan formatted data table for channel transect
sampledf_2FC <- data.frame(sample_data(physeq_obj.FC))
carnivore_rel_abun_2FC<- vegan_otu(physeq_obj.FC)
d_FC <- vegdist(carnivore_rel_abun_2FC, method="bray")
b_FC_tide<-betadisper(d_FC, sampledf_2FC$Direction)
anFC_tide<-anova(b_FC_tide)
anFC_tide
b_FC_time<-betadisper(d_FC, sampledf_2FC$Time_Point)
anFC_time<-anova(b_FC_time)
anFC_time
```

## Monitored PERMANOVA
```{r}
#Generate Vegan formatted data table
sampledf2_monitored <- data.frame(sample_data(physeq_obj.monitored))
carnivore_rel_abun_monitored <- vegan_otu(physeq_obj.monitored)

#Bray curtis dissimilarity matrix
d_carn_mon <- vegdist(carnivore_rel_abun_monitored, method="bray") 

#Permanova
broom::tidy(adonis(carnivore_rel_abun_monitored ~ sampledf2_monitored$Direction+sampledf2_monitored$Time_Point, method = "bray")$aov.tab)

```

## Aportioned Variance plot for dock transect for Figure 4
```{r, results="hide",warning=FALSE}
#Apportioning variance: OTU counts

OTU.count.adonisDK<-adonis(carnivore_rel_abun_2DK ~ sampledf_2DK$Direction+sampledf_2DK$Time_Point, method = "bray")$aov.tab
OTU.count.adonisDK

#Set up for Q Plot
qDK<-as.data.frame(OTU.count.adonisDK)
row.names(qDK)<-c("Direction of Tides","Time Point", "Residuals", "Total") # must match names correctly
qDK<-data.frame(row.names(qDK), qDK)
names(qDK)[1]<-"Level"
qDK<-qDK[-which(row.names(qDK)=="Total"),]
qDK$Level<-paste(qDK$Level, "\n",
               round(qDK$R2,2), "\n"," (p=", qDK$Pr..F., ")", 
               sep="")

qDK$Level[3] <- paste("Residuals\n0.59")

col.great4 <- c(col3.gr[2],col2.gr[2],col3.gr[5])

#Plot Figure 
jpeg(here("figures","Fig4.tiff"),  width=7.5, height=4,units="in", res=600)
q0.plotDK<-ggplot(qDK, aes(area = R2, label=Level))+
  geom_treemap(fill=col.great4, color=1, alpha=.8)+
  geom_treemap_text(colour = "white", place = "centre", grow = FALSE, size=20, fontface="bold")+
  theme(plot.background = element_blank())+
  theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.title = element_text(size = 20, face = "bold"),
                       axis.title = element_text(size = 20, face = "bold"),axis.text=element_text(size=20))
q0.plotDK
dev.off()
```

## Aportioned Variance plot for cove transect for Figure S3A
```{r, results="hide",warning=FALSE}
#Apportioning variance: OTU counts

OTU.count.adonisBF<-adonis(carnivore_rel_abun_2BF ~ sampledf_2BF$Direction+sampledf_2BF$Time_Point, method = "bray")$aov.tab
OTU.count.adonisBF

#Set up for Q Plot
qBF<-as.data.frame(OTU.count.adonisBF)
row.names(qBF)<-c("Direction of Tides","Time Point", "Residuals", "Total") # must match names correctly
qBF<-data.frame(row.names(qBF), qBF)
names(qBF)[1]<-"Level"
qBF<-qBF[-which(row.names(qBF)=="Total"),]
qBF$Level<-paste(qBF$Level, "\n",
               round(qBF$R2,2), "\n"," (p=", qBF$Pr..F., ")", 
               sep="")

qBF$Level[3] <- paste("Residuals\n0.62")

#Plot Figure 
jpeg(here("figures","FigS3A.tiff"),  width=7.5, height=4,units="in", res=600)
q0.plotBF<-ggplot(qBF, aes(area = R2, label=Level))+
  geom_treemap(fill=col.great4, color=1, alpha=.8)+
  geom_treemap_text(colour = "white", place = "centre", grow = FALSE, size=20, fontface="bold")+
  theme(plot.background = element_blank())+
  theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.title = element_text(size = 20, face = "bold"),
                       axis.title = element_text(size = 20, face = "bold"),axis.text=element_text(size=20))
q0.plotBF
dev.off()
```

## Aportioned Variance plot for channel transect for Figure S3B
```{r, results="hide",warning=FALSE}
#Apportioning variance: OTU counts

OTU.count.adonisFC<-adonis(carnivore_rel_abun_2FC ~ sampledf_2FC$Direction+sampledf_2FC$Time_Point, method = "bray")$aov.tab
OTU.count.adonisFC

#Set up for Q Plot
qFC<-as.data.frame(OTU.count.adonisFC)
row.names(qFC)<-c("Direction of Tides","Time Point", "Residuals", "Total") # must match names correctly
qFC<-data.frame(row.names(qFC), qFC)
names(qFC)[1]<-"Level"
qFC<-qFC[-which(row.names(qFC)=="Total"),]
qFC$Level<-paste(qFC$Level, "\n",
               round(qFC$R2,2), "\n"," (p=", qFC$Pr..F., ")", 
               sep="")

qFC$Level[3] <- paste("Residuals\n0.66")

#Plot Figure 
jpeg(here("figures","FigS3B.tiff"),  width=7.5, height=4,units="in", res=600)
q0.plotFC<-ggplot(qFC, aes(area = R2, label=Level))+
  geom_treemap(fill=col.great4, color=1, alpha=.8)+
  geom_treemap_text(colour = "white", place = "centre", grow = FALSE, size=20, fontface="bold")+
  theme(plot.background = element_blank())+
  theme(plot.title = element_text(hjust = 0.5)) +
   theme(plot.title = element_text(size = 20, face = "bold"),
                       axis.title = element_text(size = 20, face = "bold"),axis.text=element_text(size=20))
q0.plotFC
dev.off()
```

# Look into if the number of taxa detected changed with the presence of the foreign DNA
```{r}
#subset samples with foreign DNA
physeq_obj.noncontam_no_lab.binary <- transform_sample_counts(physeq_obj.DK, function(abund) 1*(abund>0))
withforeign1<-subset_samples(physeq_obj.noncontam_no_lab.binary, Replicate == "C" & Time_Point == "T02")
withforeign2<-subset_samples(physeq_obj.noncontam_no_lab.binary, Replicate == "B" & Time_Point == "T03")
withforeign3<-subset_samples(physeq_obj.noncontam_no_lab.binary, Time_Point == "T01")
withforeign4<-subset_samples(physeq_obj.noncontam_no_lab.binary, Time_Point == "T04")

#subset samples without foreign DNA
withoutforeign1<-subset_samples(physeq_obj.noncontam_no_lab.binary, Replicate == c("A","B") & Time_Point == "T02")
withoutforeign2<-subset_samples(physeq_obj.noncontam_no_lab.binary, Replicate == c("A","C") & Time_Point == "T03")

# make vegan objects
vegan_withforeign1<-vegan_otu(withforeign1)
vegan_withforeign2<-vegan_otu(withforeign2)
vegan_withforeign3<-vegan_otu(withforeign3)
vegan_withforeign4<-vegan_otu(withforeign4)

vegan_withoutforeign1<-vegan_otu(withoutforeign1)
vegan_withoutforeign2<-vegan_otu(withoutforeign2)

#create iNext files
withforeign<- list ("T02C"=t(vegan_withforeign1),
                "T03B"=t(vegan_withforeign2),
                "T01"=t(vegan_withforeign3),
                "T04"=t(vegan_withforeign4))
foreign<-lapply(withforeign,  as.incfreq)
out.withforeign <- iNEXT(foreign, q=0, datatype="incidence_freq", size=t3)

# calculate mean and standard of samples with foreign DNA
withforeign.mean<-c(out.withforeign$iNextEst$T02C$qD[1], 
                   out.withforeign$iNextEst$T03B$qD[1], 
                    out.withforeign$iNextEst$T01$qD[1], 
                    out.withforeign$iNextEst$T04$qD[1])
mean(withforeign.mean) 
sd(withforeign.mean)

# iNext without foreign DNA
withoutforeign<- list ("T02AB"=t(vegan_withoutforeign1),
                "T03AC"=t(vegan_withoutforeign2),
                "T00"=t(vegan_Time0),
                "T05"=t(vegan_Time5),
                "T06"=t(vegan_Time6),
                "T07"=t(vegan_Time7),
                "T08"=t(vegan_Time8),
                "T09"=t(vegan_Time9),
                "T10"=t(vegan_Time10),
                "T11"=t(vegan_Time11))
notforeign<-lapply(withoutforeign,  as.incfreq)
out.withoutforeign <- iNEXT(notforeign, q=0, datatype="incidence_freq", size=t3)

# calculate mean and standard of samples without foreign DNA
withoutforeign.mean<-c(out.withoutforeign$iNextEst$T02AB$qD[1], 
                   out.withoutforeign$iNextEst$T03AC$qD[1], 
                    out.withoutforeign$iNextEst$T00$qD[1], 
                    out.withoutforeign$iNextEst$T05$qD[1],
                    out.withoutforeign$iNextEst$T06$qD[1],
                    out.withoutforeign$iNextEst$T07$qD[1],
                    out.withoutforeign$iNextEst$T08$qD[1],
                    out.withoutforeign$iNextEst$T09$qD[1],
                    out.withoutforeign$iNextEst$T10$qD[1],
                    out.withoutforeign$iNextEst$T11$qD[1])
mean(withoutforeign.mean) 
sd(withoutforeign.mean)
```

 
# eDNA Metabarcoding Species accumulation curves for all transects (not in paper)
```{r}
#Convert to iNEXT format from Observed Species (incidence frequencies)
physeq_obj.noncontam_no_lab.binary <- transform_sample_counts(physeq_obj.ind, function(abund) 1*(abund>0))
physeq_obj.monitored.binary <- transform_sample_counts(physeq_obj.monitored, function(abund) 1*(abund>0))
physeq_obj.reefcheck.binary <- transform_sample_counts(physeq_obj.reefcheck, function(abund) 1*(abund>0))

physeq_obj.noncontam_no_lab.binary_time<-merge_samples(physeq_obj.noncontam_no_lab.binary, sample_data(physeq_obj.noncontam_no_lab.binary)[["Time_Point"]])
physeq_obj.noncontam_no_lab.binary_time <- transform_sample_counts(physeq_obj.noncontam_no_lab.binary_time, function(abund) 1*(abund>0))

#Convert to Vegan Dataframe
veganComm2.bin <- vegan_otu(physeq_obj.noncontam_no_lab.binary)
veganComm2.bin_time <- vegan_otu(physeq_obj.noncontam_no_lab.binary_time)
veganComm2.monitored.bin <- vegan_otu(physeq_obj.monitored.binary)
veganComm2.reefcheck.bin <- vegan_otu(physeq_obj.reefcheck.binary)


#Create List for iNEXT Species Incidence Frequencies
mpa_inc2 <-list ("Over All Samples"=t(veganComm2.bin),
                "Over Time"=t(veganComm2.bin_time),
                "monitored"=t(veganComm2.monitored.bin))


#Convert to iNext formatted object
species_incidence2 <-lapply(mpa_inc2, as.incfreq)

# Set Sampling Steps
t <- seq(1, 36, by=1)
t2 <- seq(1, 12, by=1)

#Run iNEXT format
out.inc2 <- iNEXT(species_incidence2, q=0, datatype="incidence_freq", size=t)
out.inc3 <- iNEXT(species_incidence2, q=0, datatype="incidence_freq", size=t2)

#View Species Capture Estimates for three samples 
out.inc2$iNextEst
# View Species Capture Estimates for all samples
out.inc3$DataInfo

# Sample‐size‐based R/E curves
jpeg(here("figures","FigS5_1.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.inc2, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

jpeg(here("figures","Fig5_2.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.inc3, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlim(1,15) +scale_x_continuous(breaks=c(0,1,3,6,9,12)) + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

# merge these two versions for a final figure in preview or powerpoint

```

# Figure 5. eDNA Metabarcoding Species accumulation curves for dock transect for Figure 5
```{r}
#Convert to iNEXT format from Observed Species (incidence frequencies)
physeq_obj.DK.binary <- transform_sample_counts(physeq_obj.DK, function(abund) 1*(abund>0))
physeq_obj.DKm.binary <- transform_sample_counts(physeq_obj.DKm, function(abund) 1*(abund>0))

physeq_obj.DK.binary_time<-merge_samples(physeq_obj.DK.binary, sample_data(physeq_obj.DK.binary)[["Time_Point"]])
physeq_obj.DK.binary_time <- transform_sample_counts(physeq_obj.DK.binary_time, function(abund) 1*(abund>0))


#Convert to Vegan Dataframe
veganComm2.binDK <- vegan_otu(physeq_obj.DK.binary)
veganComm2.binDK_time <- vegan_otu(physeq_obj.DK.binary_time)
veganComm2.binDKm<-vegan_otu(physeq_obj.DKm.binary)

#Create List for iNEXT Species Incidence Frequencies
DK_inc <-list ("Dock Over All Samples"=t(veganComm2.binDK),
                "Dock Over Time"=t(veganComm2.binDK_time))
DK_inc2 <-list ("Dock Over All Samples"=t(veganComm2.binDK),
                "Dock Monitored"=t(veganComm2.binDKm))

#Convert to iNext formatted object
species_incidenceDK <-lapply(DK_inc, as.incfreq)
species_incidenceDKm <-lapply(DK_inc2, as.incfreq)

# Set Sampling Steps
t <- seq(1, 36, by=1)
t2 <- seq(1, 12, by=1)

#Run iNEXT format
out.incDK <- iNEXT(species_incidenceDK, q=0, datatype="incidence_freq", size=t)
out.incDK2 <- iNEXT(species_incidenceDK, q=0, datatype="incidence_freq", size=t2)
out.incDK3 <- iNEXT(species_incidenceDKm, q=0, datatype="incidence_freq", size=t)

#View Species Capture Estimates for three samples 
out.incDK2$iNextEst
# View Species Capture Estimates for all samples
out.incDK$iNextEst
#View Species Capture Estimates for monitored
out.incDK3$iNextEst

# Sample‐size‐based R/E curves
jpeg(here("figures","Fig5_1.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incDK, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

jpeg(here("figures","Fig5_2.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incDK2, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlim(1,15) +scale_x_continuous(breaks=c(0,1,3,6,9,12)) + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

```

# eDNA Metabarcoding Species accumulation curves for cove and channel for Figures S6A and S6B
```{r}
#Convert to iNEXT format from Observed Species (incidence frequencies)
physeq_obj.BF.binary <- transform_sample_counts(physeq_obj.BF, function(abund) 1*(abund>0))
physeq_obj.BFm.binary <- transform_sample_counts(physeq_obj.BFm, function(abund) 1*(abund>0))
physeq_obj.FC.binary <- transform_sample_counts(physeq_obj.FC, function(abund) 1*(abund>0))
physeq_obj.FCm.binary <- transform_sample_counts(physeq_obj.FCm, function(abund) 1*(abund>0))

physeq_obj.BF.binary_time<-merge_samples(physeq_obj.BF.binary, sample_data(physeq_obj.BF.binary)[["Time_Point"]])
physeq_obj.BF.binary_time <- transform_sample_counts(physeq_obj.BF.binary_time, function(abund) 1*(abund>0))

physeq_obj.FC.binary_time<-merge_samples(physeq_obj.FC.binary, sample_data(physeq_obj.FC.binary)[["Time_Point"]])
physeq_obj.FC.binary_time <- transform_sample_counts(physeq_obj.FC.binary_time, function(abund) 1*(abund>0))

#Convert to Vegan Dataframe
veganComm2.binBF <- vegan_otu(physeq_obj.BF.binary)
veganComm2.binBF_time <- vegan_otu(physeq_obj.BF.binary_time)
veganComm2.binBFm <- vegan_otu(physeq_obj.BFm.binary)
veganComm2.binFC <- vegan_otu(physeq_obj.FC.binary)
veganComm2.binFC_time <- vegan_otu(physeq_obj.FC.binary_time)
veganComm2.binFCm <- vegan_otu(physeq_obj.FCm.binary)

#Create List for iNEXT Species Incidence Frequencies
BF_inc <-list ("Cove Over All Samples"=t(veganComm2.binBF),
                "Cove Over Time"=t(veganComm2.binBF_time))
FC_inc <-list ("Channel Over All Samples"=t(veganComm2.binFC),
                "Channel Over Time"=t(veganComm2.binFC_time))
BF_inc2<- list ("Cove Over All Samples"=t(veganComm2.binBF),
                "Cove Monitored"=t(veganComm2.binBFm))
FC_inc2<-list ("Channel Over All Samples"=t(veganComm2.binFC),
                "Channel Monitored"=t(veganComm2.binFCm))


#Convert to iNext formatted object
species_incidenceBF <-lapply(BF_inc, as.incfreq)
species_incidenceBFm <-lapply(BF_inc2, as.incfreq)
species_incidenceFC <-lapply(FC_inc, as.incfreq)
species_incidenceFCm <-lapply(FC_inc2, as.incfreq)

# Set Sampling Steps
t3 <- seq(1, 30, by=1)
t4 <- seq(1, 6, by=1)
t5 <- seq(1, 28, by=1)
t6 <- seq(1, 6, by=1)

#Run iNEXT format
out.incBF <- iNEXT(species_incidenceBF, q=0, datatype="incidence_freq", size=t3)
out.incBF2 <- iNEXT(species_incidenceBF, q=0, datatype="incidence_freq", size=t4)
out.incFC <- iNEXT(species_incidenceFC, q=0, datatype="incidence_freq", size=t5)
out.incFC2 <- iNEXT(species_incidenceFC, q=0, datatype="incidence_freq", size=t6)
out.incBFm<- iNEXT(species_incidenceBFm, q=0, datatype="incidence_freq", size=t3)
out.incFCm <- iNEXT(species_incidenceFCm, q=0, datatype="incidence_freq", size=t5)

#View Species Capture Estimates for all samples cove
out.incBF$iNextEst
# View Species Capture Estimates for time cove
out.incBF2$iNextEst
#View Species Capture Estimates for all samples channel
out.incFC$iNextEst
# View Species Capture Estimates for time channel
out.incFC2$iNextEst
#View Species Capture Estimates for all samples cove monitored
out.incBFm$iNextEst
# View Species Capture Estimates for all samples channel monitored
out.incFCm$iNextEst

# Sample‐size‐based R/E curves
jpeg(here("figures","FigS6A1.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incBF, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

jpeg(here("figures","FigS6A2.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incBF2, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlim(1,15) +scale_x_continuous(breaks=c(0,1,3,6,9,12)) + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

jpeg(here("figures","FigS6B1.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incFC, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

jpeg(here("figures","FigS6B2.tiff"),  width=7, height=4.75, units = "in", res=600)
ggiNEXT(out.incFC2, type=1) + 
  facet_wrap(~site, scales="free") + aes(fill=site, color = site) +
  theme_bw(base_size = 18) + scale_fill_manual(values=col_species, name = "Species List") + scale_color_manual(values=col_species, "Species List") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank()) + ggtitle("") + xlim(1,15) +scale_x_continuous(breaks=c(0,1,3,6,9,12)) + xlab("Number of Samples") +ylab("Number of Species") +
   theme(plot.title = element_text(size = 18, face = "bold"),
                       axis.title = element_text(size = 18, face = "bold"),axis.text=element_text(size=12), legend.title = element_text(size = 18, face = "bold") , legend.text = element_text(size=12) )+
  scale_y_continuous(breaks = scales::pretty_breaks(7), limits = c(0, NA)) + theme(strip.text.x = element_text(size = 14, colour = "black", face = "bold.italic")) +  guides(linetype=FALSE,
           colour=FALSE, 
           fill=FALSE, 
           shape=FALSE)
dev.off()

```

# Figure S4 NMDS with direction of tide
```{r}
#NMDS Bray with tide
d_carn_2 <- vegdist(carnivore_rel_abun_2, method="bray") 
ord_all_2020 <- ordinate(physeq_obj.ind, method = "NMDS", distance = d_carn_2)
col.four <- c(col_darjeeling1[3],col_darjeeling1[1],col_darjeeling1[2],col_Darjeeling2[2])
jpeg(here("figures","FigS4.tiff"), width=10, height=5.5, units="in", res=600)
nmdsplot_max <- plot_ordination(physeq_obj.ind, ord_all_2020, "Direction", color = "Direction", shape = "Direction") +
  geom_point(size=5) +
  facet_wrap(~Transect) +
  theme_bw() +  stat_ellipse(type = "t", geom = "polygon", alpha = 0.2, aes(group=Direction, fill=Direction)) +
  scale_colour_manual(values=col_nmds, name="Direction of Tide",
                      labels=c("Outgoing Tide","Peak Tide","Incoming Tide")) +
  scale_fill_manual(values=col_nmds, name="Direction of Tide",
                      labels=c("Outgoing Tide","Peak Tide","Incoming Tide"))+
  scale_shape_manual(values=c(15,16,17,18,19), name="Direction of Tide",
                      labels=c("Outgoing Tide","Peak Tide","Incoming Tide")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.text=element_text(size=16),
        axis.title=element_text(size=20,face="bold"),legend.title = element_text( size=12, face="bold"),legend.text = element_text(size=10, face="bold"))
nmdsplot_max  
dev.off()
```

# Figure S5 NMDS with temporal replicates faceted by transect
```{r}
#NMDS Bray with time
jpeg(here("figures","FigS5.tiff"), width=10, height=5.5, units= "in", res=600)
nmdsplot_max_time <- plot_ordination(physeq_obj.ind, ord_all_2020, "Time_Point", color = "Time_Point") +
  facet_wrap(~Transect) +
  geom_point(size=5) +
  theme_bw() +  geom_polygon(type = "t", geom = "polygon", alpha = 0.2, aes(group=Time_Point, fill=Time_Point)) +
  scale_color_manual(values=col.great)+
  scale_fill_manual(values=col.great)+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.text=element_text(size=16),
        axis.title=element_text(size=20,face="bold"),legend.title = element_text( size=12, face="bold"),legend.text = element_text(size=10, face="bold")) + labs(fill = "Time Point", color="Time Point")
nmdsplot_max_time
dev.off()
```

